name: deploy

on:
  push:
    branches:
      - develop

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.branch-name-check.outputs.env_name }}
    steps:
      - name: Check branch name
        id: branch-name-check
        run: |
          echo "Running on branch ${{inputs.branch}}"
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "env_name=production" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "env_name=develop" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            echo "env_name=staging" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy app to AWS Fargate
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Configure aws credentials for develop
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GithubActions@${{ github.sha }}
          aws-region: ${{ vars.AWS_REGION }}
          
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
        id: amazon-ecr-login
      
      - name: check outputs name test
        run: echo ${{ needs.check.outputs.env_name }}